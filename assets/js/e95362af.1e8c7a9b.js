"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9747],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return d}});var i=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function r(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,i,a=function(e,n){if(null==e)return{};var t,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var c=i.createContext({}),m=function(e){var n=i.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):r(r({},n),e)),t},u=function(e){var n=m(e.components);return i.createElement(c.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},g=i.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,c=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),g=m(t),d=a,h=g["".concat(c,".").concat(d)]||g[d]||p[d]||o;return t?i.createElement(h,r(r({ref:n},u),{},{components:t})):i.createElement(h,r({ref:n},u))}));function d(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,r=new Array(o);r[0]=g;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:a,r[1]=l;for(var m=2;m<o;m++)r[m]=t[m];return i.createElement.apply(null,r)}return i.createElement.apply(null,t)}g.displayName="MDXCreateElement"},6126:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return c},default:function(){return d},frontMatter:function(){return l},metadata:function(){return m},toc:function(){return p}});var i=t(7462),a=t(3366),o=(t(7294),t(3905)),r=["components"],l={slug:"T\xecm-hi\u1ec3u-regression-trong-object-detection",title:"T\xecm hi\u1ec3u regression trong object detection",authors:"thorpham",tags:["python","Object detection"]},c=void 0,m={permalink:"/blog/T\xecm-hi\u1ec3u-regression-trong-object-detection",editUrl:"https://github.com/ThorPham/blog/2018-4-18-T\xecm-hi\u1ec3u-regression-trong-object-detection/index.md",source:"@site/blog/2018-4-18-T\xecm-hi\u1ec3u-regression-trong-object-detection/index.md",title:"T\xecm hi\u1ec3u regression trong object detection",description:'*L\u1ea7n \u0111\u1ea7u ti\xean m\xecnh \u0111\u1ecdc v\u1ec1 thu\u1eadt to\xe1n YOLO(you look only one) l\xe0 tr\xean kh\xf3a "Convolution neural network" c\u1ee7a th\u1ea7y Andrew Ng tr\xean coursera.',date:"2018-04-18T00:00:00.000Z",formattedDate:"April 18, 2018",tags:[{label:"python",permalink:"/blog/tags/python"},{label:"Object detection",permalink:"/blog/tags/object-detection"}],readingTime:5.125,truncated:!0,authors:[{name:"Thorpham",title:"Deep learning enthusiast",url:"https://github.com/ThorPham",imageURL:"https://github.com/ThorPham.png",key:"thorpham"}],frontMatter:{slug:"T\xecm-hi\u1ec3u-regression-trong-object-detection",title:"T\xecm hi\u1ec3u regression trong object detection",authors:"thorpham",tags:["python","Object detection"]},prevItem:{title:"T\xecm hi\u1ec3u eigenFace trong face recognite",permalink:"/blog/T\xecm-hi\u1ec3u-eigenFace-trong-face-recognite"},nextItem:{title:"Nh\u1eadn di\u1ec7n pedestrian v\u1edbi window search",permalink:"/blog/Nh\u1eadn-di\u1ec7n-pedestrian-v\u1edbi-window-search"}},u={authorsImageUrls:[void 0]},p=[{value:"I.Chu\u1ea9n b\u1ecb d\u1eef li\u1ec7u .",id:"ichu\u1ea9n-b\u1ecb-d\u1eef-li\u1ec7u-",level:2},{value:"II.Build model.",id:"iibuild-model",level:2},{value:"III.Traing model",id:"iiitraing-model",level:2},{value:"\u0110\xe1nh gi\xe1 model",id:"\u0111\xe1nh-gi\xe1-model",level:2}],g={toc:p};function d(e){var n=e.components,l=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,i.Z)({},g,l,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("p",null,(0,o.kt)("em",{parentName:"p"},'L\u1ea7n \u0111\u1ea7u ti\xean m\xecnh \u0111\u1ecdc v\u1ec1 thu\u1eadt to\xe1n YOLO(you look only one) l\xe0 tr\xean kh\xf3a "Convolution neural network" c\u1ee7a th\u1ea7y Andrew Ng tr\xean coursera.\nC\xf3 h\xe0ng ng\xe0n c\xe2u h\u1ecfi v\xec sao \u1edf trong \u0111\u1ea7u m\xecnh hi\u1ec7n ra d\xf9 \u0111i h\u1ecfi kh\u1eafp n\u01a1i m\xe0 nhi\u1ec1u trong s\u1ed1 \u0111\xf3 v\u1eabn ch\u01b0a c\xf3 l\u1eddi gi\u1ea3i \u0111\xe1p th\u1ecfa m\xe3n m\xecnh. Trong \u0111\xf3 c\xf3 key word ',(0,o.kt)("inlineCode",{parentName:"em"},"Bounding-box regression"),", m\xecnh suy ngh\u0129 r\u1ea5t nhi\u1ec1u, \u0111\u1ecdc c\u0169ng kha kh\xe1 b\xe0i vi\u1ebft tr\xean m\u1ea1ng m\xe0 v\u1eabn kh\xf4ng hi\u1ec3u n\u1ed5i. M\u1ed9t c\xe2u h\u1ecfi c\u1ee9 l\u1edfn v\u1edfn trong \u0111\u1ea7u m\xecnh l\xe0 c\xe1c ",(0,o.kt)("inlineCode",{parentName:"em"},"bouding box")," trong thu\u1eadt to\xe1n yolo \u0111\u01b0\u1ee3c t\u1ea1o ra nh\u01b0 th\u1ebf n\xe0o ta, tr\u01b0\u1edbc gi\u1edd m\xecnh ch\u1ec9 d\xf9ng regression \u0111\u1ec3 predict  c\xe1c bi\u1ebfn li\xean t\u1ee5c v\u1eady h\u1ecd \xe1p d\u1ee5ng \u0111\u1ec3 detection bounding box ra sao. Ng\u01b0\u1eddi ta build yolo l\xe0 t\u1ed5ng h\u1ee3p c\u1ee7a r\u1ea5t nhi\u1ec1u thu\u1eadt to\xe1n t\u1ea1o n\xean b\u1ed9 x\u01b0\u01a1ng cho yolo .Thi\u1ebft ngh\u0129 nh\u1eefng ng\u01b0\u1eddi m\u1edbi l\u1ea7n \u0111\u1ea7u t\u1eadp t\u1ecde v\xe0o deep learning nh\u01b0 m\xecnh th\xec n\xean chia yolo t\u1eebng ph\u1ea7n \u0111\u1ec3 x\u1eed l\xfd c\xf3 l\u1ebd s\u1ebd d\u1ec5 th\u1edf h\u01a1n. Trong b\xe0i h\xf4m nay m\xecnh s\u1ebd l\xe0m r\xf5 ",(0,o.kt)("inlineCode",{parentName:"em"},"bounding box")," \u0111\u01b0\u1ee3c t\u1ea1o ra t\u1eeb regression nh\u01b0 th\u1ebf n\xe0o b\u1eb1ng m\u1ed9t v\xed d\u1ee5 r\u1ea5t \u0111\u01a1n gi\u1ea3n.")),(0,o.kt)("p",null,"C\xe1c b\u01b0\u01a1c th\u1ef1c hi\u1ec7n :"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Chu\u1ea9n b\u1ecb d\u1eef li\u1ec7u ."),(0,o.kt)("li",{parentName:"ul"},"Traing model ."),(0,o.kt)("li",{parentName:"ul"},"\u0110\xe1nh gi\xe1 model")),(0,o.kt)("h2",{id:"ichu\u1ea9n-b\u1ecb-d\u1eef-li\u1ec7u-"},"I.Chu\u1ea9n b\u1ecb d\u1eef li\u1ec7u ."),(0,o.kt)("p",null,"D\u1eef li\u1ec7u ",(0,o.kt)("inlineCode",{parentName:"p"},"input")," l\xe0 nh\u1eefng image c\xf3 object m\xe0 ta mu\u1ed1n detection v\xe0 ",(0,o.kt)("inlineCode",{parentName:"p"},"ouput")," l\xe0 nh\u1eefng bouding box s\u1ebd c\xf3 d\u1ea1ng (x,y,w,h). Trong \u0111\xf3 x,y l\xe0 t\u1ecda \u0111\u1ed9 leftop c\u1ee7a bounding box, (w,h) l\xe0 width v\xe0 height. Ch\xfang ta s\u1ebd m\xf4 ph\u1ecfng d\u1eef li\u1ec7u nh\u01b0 sau :"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"np.random.seed(10)\nnumber_data = 5000\nimg_size = 8\nmin_size_obj = 1\nmax_size_obj = 4\nnumber_obj = 1\n# x l\xe0 dataset image, y l\xe0 label v\u1edbi 4 tham s\u1ed1(x,y,w.h)\nbboxes = np.zeros((5000,1,4))\nimage = np.zeros((5000,img_size,img_size))\nfor i in range(5000):\n    for obj in range(number_obj):\n        w,h = np.random.randint(min_size_obj,max_size_obj,size = 2)\n        x = np.random.randint(0,img_size-w)\n        y = np.random.randint(0,img_size-h)\n        bboxes[i,obj,:] = (x,y,w,h)\n        image[i,y:y+h,x:x+w] = 1\n")),(0,o.kt)("p",null,"Gi\u1ea3i th\xedch m\u1ed9t t\xed :"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Ta s\u1ebd t\u1ea1o 5000 image c\xf3 size (8,8) ",(0,o.kt)("inlineCode",{parentName:"li"},"image = np.zeros((5000,img_size,img_size))"),". Image s\u1ebd c\xf3 background l\xe0 white"),(0,o.kt)("li",{parentName:"ul"},"5000 ",(0,o.kt)("inlineCode",{parentName:"li"},"bounding box")," c\xf3 size t\u1eeb w,h t\u1eeb 1-4 v\xe0 c\xf3 m\xe0u \u0111en"),(0,o.kt)("li",{parentName:"ul"},"M\u1ed7i image ch\u1ec9 c\xf3 duy nh\u1ea5t 1 object\nImage sau khi t\u1ea1o s\u1ebd nh\u01b0 th\u1ebf n\xe0y :")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"plt.figure(figsize=(15,15))\nplt.axis(\"off\")\nfor i in range(4):\n    plt.subplot(1,4,i+1)\n    plt.imshow(image[i],cmap=\"Greys\",interpolation='none', origin='lower', extent=[0, img_size, 0, img_size])\n    for bbox in bboxes[i]:\n        plt.gca().add_patch(matplotlib.patches.Rectangle((bbox[0], bbox[1]), bbox[2], bbox[3], ec='r', fc='none'))\n")),(0,o.kt)("p",null,(0,o.kt)("img",{loading:"lazy",alt:"bounding_box",src:t(4356).Z,width:"901",height:"222"}),"\nC\xe1i ch\xfang ta c\u1ea7n predict l\xe0 \u0111\u01b0\u1eddng vi\u1ec1n m\xe0u \u0111\u1ecf. Image s\u1ebd c\xf3 dimension l\xe0 (5000, 8, 8) ,bounding box c\xf3 dimension l\xe0 (5000, 1, 4).\nCh\xfang ta s\u1ebd d\xf9ng m\u1ed9t m\u1ea1ng neural network \u0111\u01a1n gi\u1ea3n \u0111\u1ec3 training v\u1edbi library keras. \u1ede \u0111\xe2y ng\u01b0\u1eddi ta g\u1ecdi ",(0,o.kt)("inlineCode",{parentName:"p"},"Bounding-box regression")," trong khi d\xf9ng neural network training, r\u1ea5t nhi\u1ec1u ng\u01b0\u1eddi l\u1ea7m t\u01b0\u1edfng l\xe0 d\xf9ng ",(0,o.kt)("inlineCode",{parentName:"p"},"simple regression"),". H\xe3y m\u1edf r\u1ed9ng kh\xe1i ni\u1ec7m ",(0,o.kt)("inlineCode",{parentName:"p"},"regression")," ra m\u1ed9t t\xed, n\xf3 l\xe0 b\xe0i to\xe1n predict khi output l\xe0 bi\u1ebfn li\xean t\u1ee5c. V\xec bounding box \u1edf \u0111\xe2y (x,y,w,h) l\xe0 b\u1ed1n bi\u1ebfn li\xean t\u1ee5c n\xean ta g\u1ecdi l\xe0 b\xe0i to\xe1n regression.\n\u0110\u1ea7u ti\xean ch\xfang ta s\u1ebd reshape c\xe1c bi\u1ebfn tr\u01b0\u1edbc khi \u0111\u01b0a v\xe0o model. C\u0169ng c\xf3 th\u1ec3 normalizer tr\u01b0\u1edbc khi training \u0111\u1ec3 thu\u1eadt to\xe1n h\u1ed9i t\u1ee5 nhanh h\u01a1n. Nh\u01b0ng do \u1ea3nh k\xedch th\u01b0\u1edbc nh\u1ecf v\xe0 l\xe0 binary n\xean kh\xf4ng c\u1ea7n thi\u1ebft . Sau \u0111\xf3 chia d\u1eef li\u1ec7u th\xe0nh training v\xe0 testing v\u1edbi test_size = 0.3"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"from sklearn.model_selection import train_test_split\nX = image.reshape((5000,-1))\ny = bboxes.reshape((5000,-1))\nX_train,X_test,y_train,y_test = train_test_split(X,y,test_size=0.3,random_state=10)\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"X s\u1ebd c\xf3 chi\u1ec1u l\xe0 (5000,64) "),(0,o.kt)("li",{parentName:"ul"},"y c\xf3 chi\u1ec1u l\xe0 (5000,4)")),(0,o.kt)("h2",{id:"iibuild-model"},"II.Build model."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},'from keras.models import Sequential\nfrom keras.layers import Dense,Dropout,Activation\n\nmodel = Sequential()\nmodel.add(Dense(300,input_dim =64))\nmodel.add(Dense(100))\nmodel.add(Dropout(0.2))\nmodel.add(Activation("relu"))\nmodel.add(Dense(4))\nmodel.compile(optimizer="adadelta",loss="mse")\nmodel.summary()\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Ta d\xf9ng 2 layers : layer 1 l\xe0 300 node,layer 2 l\xe0 100 node v\u1edbi activation l\xe0 ",(0,o.kt)("inlineCode",{parentName:"li"},"relu"),".Cu\u1ed1i c\xf9ng l\xe0 m\u1ed9t layer ",(0,o.kt)("inlineCode",{parentName:"li"},"dropout")," v\u1edbi t\u1ec9 l\u1ec7 20%"),(0,o.kt)("li",{parentName:"ul"},"Optimizer b\u1eb1ng ",(0,o.kt)("inlineCode",{parentName:"li"},"adadelta")," v\xe0 loss l\xe0 ",(0,o.kt)("inlineCode",{parentName:"li"},"mean square error"),".")),(0,o.kt)("center",null,(0,o.kt)("img",{width:"600",height:"300",src:t(8941).Z})),(0,o.kt)("h2",{id:"iiitraing-model"},"III.Traing model"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"model.fit(X_train,y_train,epochs=50,batch_size=200)\ny_predict = model.predict(X_test)\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Training model v\u1edbi 50 epochs v\xe0 batch size m\u1ed7i epochs l\xe0 200. M\xe1y ch\u1ea1y cpu t\u1ea7m ch\u01b0a \u0111\u1ebfn 1p"),(0,o.kt)("li",{parentName:"ul"},"Sau \u0111\xf3 predict test data d\u01b0\u1edbi variable y_predict")),(0,o.kt)("center",null,(0,o.kt)("img",{width:"600",height:"300",src:t(1840).Z})),(0,o.kt)("h2",{id:"\u0111\xe1nh-gi\xe1-model"},"\u0110\xe1nh gi\xe1 model"),(0,o.kt)("p",null,"Nh\xecn v\xe0o h\xecnh v\u1ebd \u0111\u1ea7u ti\u1ec1n ta c\xf3 nh\u1eadn x\xe9t l\xe0 : model predict t\u1ed1t l\xe0 khi \u0111\u01b0\u1eddng vi\u1ec1n m\xe0u \u0111\u1ecf v\xe0  ",(0,o.kt)("inlineCode",{parentName:"p"},"bounding box")," n\xf3 c\xe0ng s\xe1t nhau . Nh\u01b0 v\u1eady\nta c\xf3 th\u1ec3 d\xf9ng c\xe1i n\xe0y \u0111\u1ec3 \u0111\xe1nh gi\xe1 model. Ta \u0111\xe3 quen v\u1edbi kh\xe1i ni\u1ec7m ",(0,o.kt)("inlineCode",{parentName:"p"},"IOU")," l\xe0 ",(0,o.kt)("inlineCode",{parentName:"p"},"Intersection over Union"),". C\xf3 ngh\u0129a l\xe0 ta s\u1ebd \u0111\xe1nh gi\xe1 model b\u1eb1ng t\u1ec9 l\u1ec7 area overlap v\u1edbi area union gi\u1eefa th\u1ef1c t\u1ebf v\xe0 predict. Sau \u0111\xf3 t\xednh mean l\xe0 s\u1ebd ra \u0111\u01b0\u1ee3c t\u1ec9 l\u1ec7 IOU c\u1ee7a model . IOU c\xe0ng cao c\xf3 ngh\u0129a model predict t\u1ed1t v\xe0 ng\u01b0\u1ee3c l\u1ea1i."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"X\xe2y d\u1ef1ng m\u1ed9t function t\xednh IOU.")),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"def overlaping_area(detection_1,detection_2):\n    \n    x_1 = detection_1[0]\n    y_1 = detection_1[1]\n    x_w_1 = detection_1[0] + detection_1[2]\n    y_h_1 = detection_1[1] + detection_1[3]\n    \n    x_2 = detection_2[0]\n    y_2 = detection_2[1]\n    x_w_2 = detection_2[0] + detection_2[2]\n    y_h_2 = detection_2[1] + detection_2[3]\n    # t\xednh overlap theo ox,oy .N\u1ebfu ko giao nhau tr\u1ea3 v\u1ec1 0\n    overlap_x = max(0,min(x_w_1,x_w_2) - max(x_1,x_2))\n    overlap_y = max(0,min(y_h_1,y_h_2) - max(y_1,y_2))\n    # t\xednh area overlap\n    overlap_area = overlap_x*overlap_y\n    # t\xednh total area h\u1ee3p c\u1ee7a 2 detection\n    total_area = detection_1[2]*detection_1[3] + detection_2[2]*detection_2[3] - overlap_area\n    \n    return np.round(overlap_area/float(total_area),3)\n")),(0,o.kt)("p",null,"C\xe0i n\xe0y m\xecnh \u0111\xe3 \u0111\u1ec1 c\u1eadp nhi\u1ec1u trong b\xe0i vi\u1ebft tr\u01b0\u1edbc n\xean kh\xf4ng nh\u1eafc l\u1ea1i \u1edf \u0111\xe2y.\nEvaluation model b\u1eb1ng IOU"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"X_test_image = X_test.reshape((-1,8,8))\nbbox_y = y_predict.reshape((-1,1,4))\nbbx_y_true = y_test.reshape((-1,1,4))\nplt.figure(figsize=(15,15))\nfor i in range(4):\n    iou = overlaping_area(bbox_y[i].flatten(),bbx_y_true[i].flatten())\n    plt.subplot(1,4,i+1)\n    plt.imshow(X_test_image[i],cmap=\"Greys\",interpolation='none', origin='lower', extent=[0, img_size, 0, img_size])\n    for bbox in bbox_y[i]:\n        plt.gca().add_patch(matplotlib.patches.Rectangle((bbox[0], bbox[1]), bbox[2], bbox[3], ec='r', fc='none'))\n        plt.title(\"IOU = \"+str(iou),color='blue')\n")),(0,o.kt)("p",null,(0,o.kt)("img",{loading:"lazy",alt:"evaluation",src:t(2898).Z,width:"914",height:"236"})),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-py"},"IOU = []\nfor i in range(len(X_test)):\n    iou = overlaping_area(bbox_y[i].flatten(),bbx_y_true[i].flatten())\n    IOU.append(iou)\nnp.mean(IOU)\n")),(0,o.kt)("p",null,"Ta t\xednh \u0111\u01b0\u1ee3c mean cua IOU ",(0,o.kt)("inlineCode",{parentName:"p"},"0.79")," t\u1ee9c 79% t\u01b0\u01a1ng \u0111\u1ed1i t\u1ed1t, ch\xfang ta c\xf3 th\u1ec3 c\u1ea3i thi\u1ec7n model b\u1eb1ng m\u1ed9t s\u1ed1 c\xe1ch nh\u01b0 : normalizer data tr\u01b0\u1edbc khi training, thay \u0111\u1ed5i s\u1ed1 node tr\xean m\u1ed7i layer ho\u1eb7c thay \u0111\u1ed5i active fuction"))}d.isMDXComponent=!0},8941:function(e,n,t){n.Z=t.p+"assets/images/summary-4cf7268e5671f381f7d478954d39be87.jpg"},1840:function(e,n,t){n.Z=t.p+"assets/images/training-c70a21f4783d58d4ee72e9a4a361b69e.jpg"},4356:function(e,n,t){n.Z=t.p+"assets/images/bounding-44b62714ee0f792464affb0f2e2d2dcd.jpg"},2898:function(e,n,t){n.Z=t.p+"assets/images/evaluation-ef4dfe11fcfffc39b4f17e6ab3bff4db.jpg"}}]);